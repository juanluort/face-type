<!-- 1. Cargar face-api.js -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<!-- 2. Tu código personalizado -->
<script defer>
  window.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('video');
    const text = document.getElementById('text');

    function startVideo() {
      console.log('Modelos cargados, solicitando cámara…');
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          console.log('Acceso a cámara concedido.');
          video.srcObject = stream;
        })
        .catch(err => {
          console.error('Error con la cámara:', err);
        });
    }

    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri('models'),
      faceapi.nets.faceExpressionNet.loadFromUri('models')
    ]).then(startVideo);

    video.addEventListener('play', () => {
      console.log('Detectando emociones...');
      const canvas = faceapi.createCanvasFromMedia(video);
      document.body.append(canvas);
      const displaySize = { width: video.width, height: video.height };
      faceapi.matchDimensions(canvas, displaySize);

      setInterval(async () => {
        const detections = await faceapi
          .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
          .withFaceExpressions();

        if (detections.length > 0) {
          const expr = detections[0].expressions;
          const dominant = Object.entries(expr).reduce((a, b) => a[1] > b[1] ? a : b)[0];
          console.log('Emoción detectada:', dominant);
          text.className = ['happy', 'sad', 'angry'].includes(dominant) ? dominant : 'neutral';
        } else {
          console.log('Sin rostro detectado.');
          text.className = 'neutral';
        }
      }, 1000);
    });
  });
</script>
